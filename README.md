# 跑道检测系统

一个基于计算机视觉的跑道检测系统，能够自动检测图像或视频中黑色跑道的边缘，并计算出对应的中线位置。

## 功能特性

- 📸 **图像处理**: 支持JPG、PNG、BMP等常见图像格式
- 🎬 **视频处理**: 支持MP4、AVI、MOV等视频格式
- 🎯 **智能检测**: 自动检测黑色跑道边缘
- 📏 **中线计算**: 自动计算跑道中线位置
- 🎨 **可视化输出**: 自动绘制边缘和中线，并保存结果

## 安装要求

### 系统要求
- Python 3.7 或更高版本
- Windows/Linux/MacOS

### 安装依赖

```bash
pip install -r requirements.txt
```

## 使用方法

### 命令行使用

#### 处理图像

```bash
python runway_detector.py input/test_image_01.jpg output/result_02.jpg
```

#### 处理视频

```bash
python runway_detector.py input/test_video_01.mp4 output/result_01.mp4
```

### 使用演示脚本

```bash
python demo.py
```

这将自动处理input文件夹下的所有图像和视频文件，并将结果保存到output文件夹。

### 诊断工具

如果检测效果不佳，可以使用诊断工具来可视化处理过程：

```bash
python diagnose.py input/test_image_01.jpg
```

这将生成一个包含6个处理步骤的诊断图像，帮助您理解检测过程。

## 目录结构

```
runway-detection/
├── input/              # 输入文件目录
│   ├── test_image_01.jpg
│   ├── test_image_02.jpg
│   └── test_video_01.mp4
├── output/             # 输出文件目录（自动创建）
├── runway_detector.py  # 核心检测程序
├── demo.py             # 演示脚本
├── requirements.txt    # 依赖文件
└── README.md          # 说明文档
```

## 工作原理

1. **颜色空间转换**: 将图像从BGR转换为HSV色彩空间，便于检测暗色区域
2. **自适应阈值**: 使用HSV的V（亮度）通道检测暗色区域（V值<80）
3. **形态学操作**: 使用闭运算连接断开区域，开运算去除小噪点
4. **轮廓查找**: 找到暗色区域轮廓并筛选有效区域（面积>5%）
5. **边界扫描**: 对每一行扫描，使用pointPolygonTest找到跑道轮廓的左右边界点
6. **中点计算**: 对每个y坐标，计算左右边界的算术中点作为中线点
7. **智能拟合**: 
   - 优先使用样条插值（scipy.UnivariateSpline）自然连接所有中点
   - 样条插值能自动适配局部曲率变化，适合弯曲跑道
   - 如无scipy则回退到加权5次多项式拟合
8. **可视化**: 每像素绘制，生成平滑的蓝色中线

## 技术细节

### 颜色阈值
- HSV亮度通道阈值: V值 < 80 (检测较暗的区域)
- 这是自适应的暗色区域检测，不依赖具体颜色
- 可以处理不同光照条件下的黑色或深色跑道

### 中线计算
- **边界检测**: 使用pointPolygonTest精确定位左右边界点
- **中点算法**: 对每个y坐标计算左右边界的算术中点
- **样条插值**: 使用UnivariateSpline自然连接中点，自动适配局部曲率
- **回退机制**: 如无scipy则使用加权5次多项式拟合
- **密集渲染**: 每像素绘制一次，确保中线平滑无锯齿
- 采样密度：每2像素一行
- 至少需要10个采样点才会绘制中线

## 输出说明

- **轮廓线条**: 检测到的跑道轮廓
- **蓝色线条**: 计算出的跑道中线（多项式拟合）
- 输出文件保存在`output/`目录

注意：如果检测不到跑道或中线，可能的原因：
1. 跑道区域太亮（建议V值<80）
2. 跑道面积太小（建议占图像面积>5%）
3. 跑道不明显或被遮挡

## 注意事项

1. 确保输入图像/视频中有明显的黑色跑道区域
2. 图像质量和光照条件会影响检测效果
3. 对于复杂场景，可能需要调整颜色阈值参数
4. 建议输入的分辨率不要过低

## 常见问题

**Q: 检测不到跑道怎么办？**  
A: 使用诊断工具查看处理过程：`python diagnose.py input/test_image_01.jpg`  
   检查跑道是否足够暗（V值<80）且面积足够大（>5%）

**Q: 中线不准确怎么办？**  
A: 当前已使用加权拟合，对弯曲跑道更准确  
   如果仍有问题，可设置`debug=True`查看采样点分布  
   （在runway_detector.py的`RunwayDetector(debug=True)`）

**Q: 处理视频很慢？**  
A: 这是正常的，视频处理需要逐帧分析，可以考虑降低视频分辨率或帧率。

## 许可证

本项目仅供学习和研究使用。

## 作者

创建于 2025

